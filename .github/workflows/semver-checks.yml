name: Rust semver-checks

on:
    pull_request:
        branches:
            - master
    pull_request_target:
        branches:
            - master
        types:
            - opened
            - edited
            - synchronize
            - reopened
    workflow_dispatch:
        inputs:
            base:
                description: 'Base branch or tag to run the semver checks against.'
                required: true
                default: 'master'

jobs:
  semver-checks:
    name: semver-checks ðŸ¦€
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          path: PR_BRANCH
      # Remove repo toolchain pin so we can specify toolchain manually
      - name: Remove toolchain pin
        run: rm -f rust-toolchain.toml rustup-toolchain.toml
      - name: Checkout baseline
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha || github.event.inputs.base }}
          path: BASELINE_BRANCH
      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Build caching
        uses: Swatinem/rust-cache@v2

      # Run cargo-semver-checks against the PR's target branch.
      - name: Install latest cargo-semver-checks
        run: cargo install --git https://github.com/obi1kenobi/cargo-semver-checks cargo-semver-checks
      - name: Check semver
        id: check-changes
        run: cargo semver-checks check-release --baseline-rev ${{ github.event.pull_request.base.sha || github.event.inputs.base }} --release-type minor
        continue-on-error: true
      
      - name: Set breaking flag
        id: set-breaking
        run: |
          if [ "${{ steps.check-changes.outcome }}" == "failure" ]; then
            echo "breaking=true" >> $GITHUB_OUTPUT
            echo "semver_checks_diagnostic=${{ steps.check-changes.outputs.semver-checks-output }}" >> $GITHUB_OUTPUT
          else
            echo "breaking=false" >> $GITHUB_OUTPUT
            echo "semver_checks_diagnostic=${{ steps.check-changes.outputs.semver-checks-output }}" >> $GITHUB_OUTPUT
          fi
      
      # Check if the PR title contains a breaking change flag in its title,
      # according to the conventional commits specification.
      #
      # When the PR is flagged as breaking we only post an informative comment
      # instead of failing the workflow.
      - name: Check for breaking change flag
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        id: breaking-pr
        run: |
          if [[ "${PR_TITLE}" =~ ^.*\!:.*$ ]]; then
            echo "breaking=true" >> $GITHUB_OUTPUT
          else
            echo "breaking=false" >> $GITHUB_OUTPUT
          fi
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}

      # Debug step 
      - run: |
          echo "breaking: ${{ steps.set-breaking.outputs.breaking }}"
          echo "breaking-pr: ${{ steps.breaking-pr.outputs.breaking }}"

      # Post a diagnostics comment if there are breaking changes and the PR has been marked as breaking.
      - name: Post a comment about the breaking changes. PR marked as breaking.
        if: ${{ (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && steps.set-breaking.outputs.breaking == 'true' && steps.breaking-pr.outputs.breaking == 'true' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: rs-semver-checks
          message: |
            This PR contains breaking changes to the public Rust API.

            <details>
              <summary>cargo-semver-checks summary</summary>
              
              ```
              ${{ steps.set-breaking.outputs.semver_checks_diagnostic }}
              ```
              
            </details>
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}

      # Post a help comment if there are breaking changes, and the PR hasn't been marked as breaking.
      - name: Post a comment about the breaking changes. PR *not* marked as breaking.
        if: ${{ (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && steps.set-breaking.outputs.breaking == 'true' && steps.breaking-pr.outputs.breaking == 'false' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: rs-semver-checks
          message: |
            This PR contains breaking changes to the public Rust API.
            Please deprecate the old API instead (if possible), or mark the PR with a `!` following the [conventional commits](https://www.conventionalcommits.org/en/v1.0.0/) format to indicate a breaking change.

            <details>
              <summary>cargo-semver-checks summary</summary>
              
              ```
              ${{ steps.set-breaking.outputs.semver_checks_diagnostic }}
              ```
              
            </details>
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
      - name: Fail if there are undeclared breaking changes
        if: ${{ steps.set-breaking.outputs.breaking == 'true' && steps.breaking-pr.outputs.breaking == 'false' }}
        run: exit 1

      # Delete previous comments when the issues have been resolved
      # This step doesn't run if any of the previous checks fails.
      - name: Delete previous comments
        uses: marocchino/sticky-pull-request-comment@v2
        if: ${{ (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && steps.set-breaking.outputs.breaking == 'false' }}
        with:
          header: rs-semver-checks
          delete: true
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
